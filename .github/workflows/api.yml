# Container Apps API Pipeline
# Builds and deploys the API to Azure Container Apps

name: API - Build and Deploy

on:
  push:
    branches: [main]
    paths:
      - 'api/**'
      - 'infrastructure/bicep/container-app.bicep'
      - '.github/workflows/api.yml'
  workflow_dispatch:

env:
  AZURE_CONTAINER_REGISTRY: crctnasrdev
  IMAGE_NAME: ctn-asr-api
  RESOURCE_GROUP: rg-ctn-demo-asr-dev
  CONTAINER_APP_NAME: ca-ctn-asr-api-dev

jobs:
  schema-tests:
    name: Schema Contract Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci --workspace=api

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run Schema Contract Tests
        run: |
          # Get PostgreSQL password from Key Vault
          POSTGRES_PASSWORD=$(az keyvault secret show \
            --vault-name kv-ctn-demo-asr-dev \
            --name postgres-password \
            --query value \
            --output tsv)

          cd api
          export PGHOST=psql-ctn-demo-asr-dev.postgres.database.azure.com
          export PGPORT=5432
          export PGDATABASE=asr_dev
          export PGUSER=asradmin
          export PGPASSWORD=$POSTGRES_PASSWORD

          echo "Running schema contract tests..."
          npm run test:schema-contracts

  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: schema-tests
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY }}

      - name: Build and push Docker image
        id: meta
        run: |
          TAG="${{ github.run_number }}"
          IMAGE="${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}"

          docker build \
            -t ${IMAGE}:${TAG} \
            -t ${IMAGE}:latest \
            -f api/Dockerfile \
            api/

          docker push ${IMAGE}:${TAG}
          docker push ${IMAGE}:latest

          echo "Image pushed: ${IMAGE}:${TAG}"
          echo "tags=${IMAGE}:${TAG}" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy to Container Apps
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep template
        run: |
          TAG="${{ github.run_number }}"
          IMAGE="${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${TAG}"

          az deployment group create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --template-file infrastructure/bicep/container-app.bicep \
            --parameters \
              environmentName=dev \
              containerImage=${IMAGE}

      - name: Force Container App update
        run: |
          TAG="${{ github.run_number }}"
          IMAGE="${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${TAG}"

          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${IMAGE}

      - name: Health Check
        run: |
          sleep 30

          CONTAINER_APP_URL=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv)

          echo "Checking health at https://$CONTAINER_APP_URL/api/health"

          for i in 1 2 3 4 5; do
            HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://$CONTAINER_APP_URL/api/health")
            if [ "$HEALTH_STATUS" = "200" ]; then
              echo "Health check passed!"
              curl -s "https://$CONTAINER_APP_URL/api/health" | jq .
              exit 0
            fi
            echo "Attempt $i: HTTP $HEALTH_STATUS - waiting..."
            sleep 10
          done

          echo "Health check failed after 5 attempts"
          exit 1

  smoke-tests:
    name: API Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run Smoke Tests
        run: |
          CONTAINER_APP_URL=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv)

          API_BASE="https://$CONTAINER_APP_URL/api"

          echo "Testing API at $API_BASE"

          echo "Testing /health..."
          curl -s "$API_BASE/health" | jq .

          echo "Testing /v1/version..."
          curl -s "$API_BASE/v1/version" | jq .

          echo "API smoke tests completed!"
