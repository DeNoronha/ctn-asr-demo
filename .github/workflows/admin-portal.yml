# Admin Portal - CI/CD Pipeline
# Deploys to Azure Static Web Apps

name: Admin Portal - Build and Deploy

on:
  push:
    branches: [main]
    paths:
      - 'admin-portal/**'
      - '!admin-portal/**/*.md'
      - '.github/workflows/admin-portal.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  VITE_AZURE_CLIENT_ID: d3037c11-a541-4f21-8862-8079137a0cde
  VITE_AZURE_TENANT_ID: 598664e7-725c-4daa-bd1f-89c4ada717ff
  VITE_REDIRECT_URI: https://calm-tree-03352ba03.1.azurestaticapps.net
  VITE_API_URL: https://ca-ctn-asr-api-dev.calmriver-700a8c55.westeurope.azurecontainerapps.io/api/v1

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: TypeScript check
        run: cd admin-portal && npm run typecheck

      - name: Lint check
        run: npm run lint -w admin-portal
        continue-on-error: true

      - name: Security audit
        run: |
          cd admin-portal
          npm audit --audit-level=moderate || true
        continue-on-error: true

      - name: Install Trivy
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update -qq
          sudo apt-get install -y trivy

      - name: Trivy vulnerability scan
        run: |
          cd admin-portal
          trivy fs --severity HIGH,CRITICAL --exit-code 1 --scanners vuln .

      - name: Trivy secret scan
        run: trivy fs --scanners secret --exit-code 1 --severity HIGH,CRITICAL .

      - name: Install Semgrep
        run: pip3 install semgrep

      - name: Semgrep SAST scan
        run: |
          echo "Running Semgrep security analysis..."
          semgrep scan --config=auto \
            --severity=ERROR \
            --severity=WARNING \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='*.test.ts' \
            --exclude='*.spec.ts' \
            --exclude='e2e' \
            admin-portal/ || true
        continue-on-error: true

      - name: Run unit tests (Vitest)
        run: npm run test:ci -w admin-portal || true
        continue-on-error: true
        env:
          CI: true

      - name: Generate version.json
        run: |
          chmod +x scripts/generate-version.sh
          ./scripts/generate-version.sh admin-portal/public

      - name: Build
        run: npm run build -w admin-portal
        env:
          CI: false
          NODE_ENV: production

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.ADMIN_PORTAL_DEPLOYMENT_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'admin-portal/build'
          skip_app_build: true

      - name: Verify deployment
        run: |
          sleep 15
          PORTAL_URL="https://calm-tree-03352ba03.1.azurestaticapps.net"

          for i in 1 2 3 4 5; do
            PORTAL_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$PORTAL_URL")
            if [ "$PORTAL_STATUS" = "200" ]; then
              echo "Admin Portal deployed successfully!"
              echo "URL: $PORTAL_URL"
              exit 0
            fi
            echo "Attempt $i: HTTP $PORTAL_STATUS - waiting..."
            sleep 10
          done

          echo "Deployment verification failed"
          exit 1
