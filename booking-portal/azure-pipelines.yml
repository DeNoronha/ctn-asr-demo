# CTN DocuFlow (Booking Portal) - CI/CD Pipeline
# Quality validation with Biome, npm audit, and Aikido security scanning
# All quality checks use continueOnError: true (informational only, don't block deployment)

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - booking-portal/**

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: ctn-booking-portal-variables
  - name: FUNCTION_APP_NAME
    value: 'func-ctn-booking-prod'
  - name: STATIC_WEB_APP_NAME
    value: 'swa-ctn-booking-prod'
  - name: NODE_VERSION
    value: '20.x'
  - name: AZURE_SUBSCRIPTION
    value: 'azure-ctn-demo'
  - name: keyVaultName
    value: 'kv-ctn-demo-asr-dev'
  - name: azureSubscription
    value: 'Azure-CTN-ASR-ServiceConnection'

stages:
  - stage: QualityValidation
    displayName: 'Quality & Security Validation'
    jobs:
      - job: CodeQuality
        displayName: 'Code Quality Checks'
        steps:
          # Fetch secrets from Azure Key Vault
          - task: AzureKeyVault@2
            displayName: 'Fetch secrets from Key Vault'
            inputs:
              azureSubscription: $(azureSubscription)
              KeyVaultName: $(keyVaultName)
              SecretsFilter: 'AIKIDO-CI-API-KEY'
              RunAsPreJob: true
            continueOnError: true

          - task: NodeTool@0
            inputs:
              versionSpec: $(NODE_VERSION)
            displayName: 'Install Node.js'

          - script: |
              npm ci --legacy-peer-deps
            displayName: 'Install all workspace dependencies'

          # ESLint code quality checks - REPORT ONLY
          - script: |
              cd booking-portal/web
              npm run lint
            displayName: 'Run ESLint code quality checks (Frontend)'
            continueOnError: true

          # npm security audit
          - script: |
              cd booking-portal/web
              npm audit --audit-level=moderate
            displayName: 'Run npm security audit (Frontend)'
            continueOnError: true

          - script: |
              cd booking-portal/api
              npm audit --audit-level=moderate
            displayName: 'Run npm security audit (API)'
            continueOnError: true

          # Aikido Security scan
          - script: |
              npm install -g @aikidosec/ci-api-client
              aikido-api-client apikey $(AIKIDO-CI-API-KEY)
            displayName: 'Install Aikido CI client'
            continueOnError: true

          - script: |
              cd booking-portal
              git fetch origin main --depth=50
              BASE_COMMIT=$(git rev-parse HEAD~1)
              HEAD_COMMIT=$(git rev-parse HEAD)
              echo "Scanning commits: $BASE_COMMIT -> $HEAD_COMMIT"
              aikido-api-client scan 1094319 $BASE_COMMIT $HEAD_COMMIT main \
                --minimum-severity-level MEDIUM \
                --fail-on-sast-scan \
                --fail-on-secrets-scan
            displayName: 'Run Aikido Security scan'
            env:
              AIKIDO_CI_API_KEY: $(AIKIDO-CI-API-KEY)
            continueOnError: true

          - task: PublishPipelineArtifact@1
            displayName: 'Publish security reports'
            condition: always()
            inputs:
              targetPath: 'booking-portal/reports'
              artifact: 'security-reports-booking'
              publishLocation: 'pipeline'
            continueOnError: true

  - stage: Build
    displayName: 'Build Stage'
    dependsOn: QualityValidation
    condition: always()
    jobs:
      - job: BuildAPI
        displayName: 'Build Backend API'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: $(NODE_VERSION)
            displayName: 'Install Node.js'

          - script: |
              # Install all workspace dependencies from root
              npm install
              # Install booking portal API dependencies
              cd booking-portal/api
              npm install
              # Build API
              npm run build
            displayName: 'Install dependencies and build API'

          - script: |
              # Remove node_modules to reduce package size
              # Azure Functions will install dependencies remotely
              rm -rf booking-portal/api/node_modules

              # Verify package size reduction
              du -sh booking-portal/api
            displayName: 'Remove node_modules before packaging'

          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: 'booking-portal/api'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/api-$(Build.BuildId).zip'
              replaceExistingArchive: true
            displayName: 'Archive API files (without node_modules)'

          - publish: $(Build.ArtifactStagingDirectory)/api-$(Build.BuildId).zip
            artifact: api
            displayName: 'Publish API artifact'

      - job: BuildFrontend
        displayName: 'Build Frontend'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: $(NODE_VERSION)
            displayName: 'Install Node.js'

          - script: |
              # Install all workspace dependencies from root (if not already done)
              npm install
              # Install booking portal web dependencies
              cd booking-portal/web
              npm install
              # Build frontend
              npm run build
            displayName: 'Install dependencies and build frontend'

          - publish: booking-portal/web/build
            artifact: frontend
            displayName: 'Publish frontend artifact'

  - stage: DeployDev
    displayName: 'Deploy to Production'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: DeployFunctionApp
        displayName: 'Deploy API to Function App'
        steps:
          - download: current
            artifact: api
            displayName: 'Download API artifact'

          - task: AzureFunctionApp@2
            inputs:
              azureSubscription: $(AZURE_SUBSCRIPTION)
              appType: 'functionApp'
              appName: $(FUNCTION_APP_NAME)
              package: '$(Pipeline.Workspace)/api/*.zip'
              deploymentMethod: 'zipDeploy'
              # Enable remote build - Azure will install node_modules
              appSettings: '-SCM_DO_BUILD_DURING_DEPLOYMENT true -ENABLE_ORYX_BUILD true'
            displayName: 'Deploy API to Azure Function App (with remote build)'

      - job: DeployStaticWebApp
        displayName: 'Deploy Frontend to Static Web App'
        steps:
          - checkout: self
            submodules: false
            displayName: 'Checkout source code'

          - download: current
            artifact: frontend
            displayName: 'Download frontend artifact'

          - task: NodeTool@0
            inputs:
              versionSpec: $(NODE_VERSION)
            displayName: 'Install Node.js'

          - script: |
              cp -r $(Pipeline.Workspace)/frontend booking-portal/web/build
            displayName: 'Copy frontend build artifact'

          - task: AzureStaticWebApp@0
            inputs:
              app_location: 'booking-portal/web/build'
              output_location: ''
              azure_static_web_apps_api_token: $(AZURE_STATIC_WEB_APPS_API_TOKEN_BOOKING)
            displayName: 'Deploy Frontend to Static Web App'
