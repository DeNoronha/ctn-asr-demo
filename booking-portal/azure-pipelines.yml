trigger:
  branches:
    include:
      - main
  paths:
    include:
      - booking-portal/**

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: ctn-booking-portal-variables
  - name: FUNCTION_APP_NAME
    value: 'func-ctn-booking-prod'
  - name: STATIC_WEB_APP_NAME
    value: 'swa-ctn-booking-prod'
  - name: NODE_VERSION
    value: '20.x'

stages:
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: BuildAPI
        displayName: 'Build Backend API'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: $(NODE_VERSION)
            displayName: 'Install Node.js'

          - script: |
              cd booking-portal/api
              npm ci
              npm run build
            displayName: 'Install dependencies and build API'

          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: 'booking-portal/api'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/api-$(Build.BuildId).zip'
              replaceExistingArchive: true
            displayName: 'Archive API files'

          - publish: $(Build.ArtifactStagingDirectory)/api-$(Build.BuildId).zip
            artifact: api
            displayName: 'Publish API artifact'

      - job: BuildFrontend
        displayName: 'Build Frontend'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: $(NODE_VERSION)
            displayName: 'Install Node.js'

          - script: |
              cd booking-portal/web
              npm ci
              npm run build
            displayName: 'Install dependencies and build frontend'

          - publish: booking-portal/web/build
            artifact: frontend
            displayName: 'Publish frontend artifact'

  - stage: DeployDev
    displayName: 'Deploy to Production'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployAPI
        displayName: 'Deploy Backend API'
        environment: 'ctn-booking-production'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: api
                  displayName: 'Download API artifact'

                - task: AzureFunctionApp@2
                  inputs:
                    azureSubscription: 'Azure-CTN-ASR-ServiceConnection'
                    appType: 'functionAppLinux'
                    appName: $(FUNCTION_APP_NAME)
                    package: '$(Pipeline.Workspace)/api/api-$(Build.BuildId).zip'
                    deploymentMethod: 'zipDeploy'
                  displayName: 'Deploy to Azure Functions'

      - deployment: DeployFrontend
        displayName: 'Deploy Frontend'
        environment: 'ctn-booking-production'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: frontend
                  displayName: 'Download frontend artifact'

                - task: AzureStaticWebApp@0
                  inputs:
                    app_location: '$(Pipeline.Workspace)/frontend'
                    api_location: ''
                    output_location: ''
                    azure_static_web_apps_api_token: $(AZURE_STATIC_WEB_APPS_API_TOKEN_BOOKING)
                  displayName: 'Deploy to Static Web App'
