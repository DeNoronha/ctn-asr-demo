# Azure Pipeline Example for CTN Documentation with MCP Server Integration
#
# This example shows how to integrate MCP server refresh into your
# documentation deployment pipeline.
#
# Add the "Refresh MCP Server" task after your documentation is deployed
# to ensure the MCP server has the latest content.

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - docs/**
      - web/**

pool:
  vmImage: 'ubuntu-latest'

variables:
  # Set these in your pipeline variables (mark MCP_API_KEY as secret)
  # MCP_SERVER_URL: 'ca-ctn-mcp-server.kindwave-xxxxx.westeurope.azurecontainerapps.io'
  # MCP_API_KEY: '***' (secret variable)

stages:
  - stage: Build
    displayName: 'Build Documentation'
    jobs:
      - job: BuildDocs
        displayName: 'Build documentation site'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'
            displayName: 'Install Node.js'

          - script: |
              npm ci
              npm run build
            displayName: 'Build documentation'
            workingDirectory: '$(Build.SourcesDirectory)'

          - publish: '$(Build.SourcesDirectory)/build'
            artifact: documentation
            displayName: 'Publish build artifact'

  - stage: Deploy
    displayName: 'Deploy to Azure'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployStaticWebApp
        displayName: 'Deploy to Static Web App'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: documentation

                - task: AzureStaticWebApp@0
                  inputs:
                    app_location: '$(Pipeline.Workspace)/documentation'
                    # ... your Static Web App configuration ...
                  displayName: 'Deploy to Static Web App'

      - job: RefreshMCPServer
        displayName: 'Refresh MCP Server Documentation'
        dependsOn: DeployStaticWebApp
        condition: succeeded()
        steps:
          - task: Bash@3
            displayName: 'Trigger MCP Server Refresh'
            inputs:
              targetType: 'inline'
              script: |
                echo "Triggering MCP server documentation refresh..."

                # Trigger refresh endpoint
                RESPONSE=$(curl -X POST https://$(MCP_SERVER_URL)/refresh \
                  -H "X-API-Key: $(MCP_API_KEY)" \
                  -H "Content-Type: application/json" \
                  -w "\n%{http_code}" \
                  -s)

                # Extract HTTP status code
                HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
                BODY=$(echo "$RESPONSE" | head -n-1)

                echo "HTTP Status: $HTTP_CODE"
                echo "Response: $BODY"

                # Check if successful (200 status)
                if [ "$HTTP_CODE" -eq 200 ]; then
                  echo "✓ MCP server documentation refreshed successfully"
                  echo "$BODY" | jq .
                  exit 0
                else
                  echo "✗ MCP server refresh failed with HTTP $HTTP_CODE"
                  echo "$BODY"
                  exit 1
                fi
            continueOnError: true  # Don't fail pipeline if MCP refresh fails

          - task: Bash@3
            displayName: 'Verify MCP Server Health'
            inputs:
              targetType: 'inline'
              script: |
                echo "Checking MCP server health..."

                # Wait a moment for refresh to complete
                sleep 5

                # Check health endpoint
                HEALTH=$(curl -s https://$(MCP_SERVER_URL)/health)

                echo "Health check response:"
                echo "$HEALTH" | jq .

                # Verify lastRefresh is recent (within last 5 minutes)
                LAST_REFRESH=$(echo "$HEALTH" | jq -r '.lastRefresh')
                echo "Last refresh: $LAST_REFRESH"

                if [ "$LAST_REFRESH" != "null" ]; then
                  echo "✓ MCP server is healthy and recently refreshed"
                else
                  echo "⚠ Warning: MCP server health check inconclusive"
                fi
            continueOnError: true

  - stage: Notify
    displayName: 'Notification'
    dependsOn: Deploy
    condition: succeededOrFailed()
    jobs:
      - job: NotifyTeam
        displayName: 'Notify team of deployment'
        steps:
          - task: Bash@3
            displayName: 'Send notification'
            inputs:
              targetType: 'inline'
              script: |
                echo "Documentation deployed and MCP server refreshed"
                echo "Team members can now access updated documentation via Claude Desktop"
                echo ""
                echo "MCP Server URL: https://$(MCP_SERVER_URL)"
                echo "Documentation URL: https://delightful-desert-0e783ed03.1.azurestaticapps.net"
