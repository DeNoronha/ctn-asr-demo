/**
 * TEST FILE - INTENTIONAL VULNERABILITY
 * This file contains an intentional SQL injection vulnerability
 * for testing Semgrep blocking behavior in the CI/CD pipeline.
 *
 * DO NOT DEPLOY TO PRODUCTION
 * This file will be removed after testing.
 */

import { app, HttpRequest, HttpResponseInit, InvocationContext } from '@azure/functions';

/**
 * Test endpoint with INTENTIONAL SQL injection vulnerability
 * This should trigger Semgrep ERROR severity finding
 */
export async function testSemgrepVulnerability(
  request: HttpRequest,
  context: InvocationContext
): Promise<HttpResponseInit> {
  context.log('Testing Semgrep detection...');

  const userId = request.query.get('userId');

  // INTENTIONAL VULNERABILITY: SQL Injection
  // This pattern should be detected by Semgrep as ERROR severity
  const query = `SELECT * FROM users WHERE id = ${userId}`;

  // This should also trigger Semgrep
  const unsafeQuery = "SELECT * FROM members WHERE name = '" + request.query.get('name') + "'";

  return {
    status: 200,
    jsonBody: {
      message: 'This endpoint contains intentional vulnerabilities for testing',
      vulnerabilities: [
        'SQL Injection via direct string concatenation',
        'Unparameterized query with user input'
      ]
    }
  };
}

// Register the function (for testing only)
app.http('test-semgrep-vulnerability', {
  methods: ['GET'],
  authLevel: 'anonymous', // Another security issue
  handler: testSemgrepVulnerability
});
