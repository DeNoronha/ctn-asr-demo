# CTN Orchestrator Portal - CI/CD Pipeline
# Builds React app and deploys to Azure Static Web App

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - orchestrator-portal/**
      - azure-pipelines.yml

pr:
  branches:
    include:
      - main

variables:
  - group: ctn-orchestrator-portal-variables
  - name: NODE_VERSION
    value: '20.x'
  - name: BUILD_OUTPUT_FOLDER
    value: 'dist'

stages:
  - stage: Build
    displayName: 'Build Orchestrator Portal'
    jobs:
      - job: BuildReactApp
        displayName: 'Build React Application'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: |
              echo "ğŸ” Validating required environment variables..."
              EXIT_CODE=0

              # Check VITE_API_BASE_URL
              if [ -z "$(VITE_API_BASE_URL)" ]; then
                echo "âŒ ERROR: VITE_API_BASE_URL is not set"
                EXIT_CODE=1
              else
                echo "âœ… VITE_API_BASE_URL is set"
              fi

              # Check VITE_KENDO_LICENSE_KEY (optional but warn if missing)
              if [ -z "$(VITE_KENDO_LICENSE_KEY)" ]; then
                echo "âš ï¸ WARNING: VITE_KENDO_LICENSE_KEY is not set (Kendo will show trial banner)"
              else
                echo "âœ… VITE_KENDO_LICENSE_KEY is set"
              fi

              if [ $EXIT_CODE -ne 0 ]; then
                echo ""
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "ğŸš« Build blocked - Missing required variables"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo ""
                echo "Please ensure the 'ctn-orchestrator-portal-variables' variable group contains:"
                echo "  - VITE_API_BASE_URL (required)"
                echo "  - VITE_KENDO_LICENSE_KEY (optional)"
                echo ""
                exit 1
              fi

              echo ""
              echo "âœ… All required variables validated"
            displayName: 'Validate environment variables'

          - task: NodeTool@0
            displayName: 'Install Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - task: Npm@1
            displayName: 'npm install'
            inputs:
              command: 'install'
              workingDir: '.'

          - script: npm run build
            displayName: 'Build React app with Vite'
            env:
              NODE_ENV: production
              VITE_API_BASE_URL: $(VITE_API_BASE_URL)
              VITE_KENDO_LICENSE_KEY: $(VITE_KENDO_LICENSE_KEY)

          - task: CopyFiles@2
            displayName: 'Copy Static Web App config'
            inputs:
              SourceFolder: '.'
              Contents: 'staticwebapp.config.json'
              TargetFolder: '$(BUILD_OUTPUT_FOLDER)'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish build artifacts'
            inputs:
              PathtoPublish: '$(BUILD_OUTPUT_FOLDER)'
              ArtifactName: 'orchestrator-portal'
              publishLocation: 'Container'

  - stage: Deploy
    displayName: 'Deploy to Production'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: DeployStaticWebApp
        displayName: 'Deploy to Azure Static Web App'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: |
              echo "ğŸ” Validating deployment token..."

              if [ -z "$(AZURE_STATIC_WEB_APPS_API_TOKEN)" ]; then
                echo "âŒ ERROR: AZURE_STATIC_WEB_APPS_API_TOKEN is not set"
                echo ""
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "ğŸš« Deployment blocked - Missing deployment token"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo ""
                echo "Please add AZURE_STATIC_WEB_APPS_API_TOKEN to the 'ctn-orchestrator-portal-variables' variable group"
                echo ""
                exit 1
              fi

              echo "âœ… Deployment token validated"
            displayName: 'Validate deployment token'

          - download: current
            artifact: orchestrator-portal
            displayName: 'Download build artifacts'

          - script: ls -la $(Pipeline.Workspace)/orchestrator-portal
            displayName: 'List downloaded artifacts'

          - script: |
              npx @azure/static-web-apps-cli deploy $(Pipeline.Workspace)/orchestrator-portal \
                --deployment-token $(AZURE_STATIC_WEB_APPS_API_TOKEN) \
                --env production
            displayName: 'Deploy to Azure Static Web App using SWA CLI'
