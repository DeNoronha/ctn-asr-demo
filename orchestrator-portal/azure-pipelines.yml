# CTN Orchestrator Portal - CI/CD Pipeline
# Builds React app and deploys to Azure Static Web App

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - orchestrator-portal/**
      - azure-pipelines.yml

pr:
  branches:
    include:
      - main

variables:
  - group: ctn-orchestrator-portal-variables
  - name: NODE_VERSION
    value: '20.x'
  - name: BUILD_OUTPUT_FOLDER
    value: 'dist'

stages:
  - stage: Build
    displayName: 'Build Orchestrator Portal'
    jobs:
      - job: BuildReactApp
        displayName: 'Build React Application'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - task: Npm@1
            displayName: 'npm install'
            inputs:
              command: 'install'
              workingDir: '.'

          - script: npm run build
            displayName: 'Build React app with Vite'
            env:
              NODE_ENV: production
              VITE_API_BASE_URL: $(VITE_API_BASE_URL)
              VITE_KENDO_LICENSE_KEY: $(VITE_KENDO_LICENSE_KEY)

          - task: CopyFiles@2
            displayName: 'Copy Static Web App config'
            inputs:
              SourceFolder: '.'
              Contents: 'staticwebapp.config.json'
              TargetFolder: '$(BUILD_OUTPUT_FOLDER)'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish build artifacts'
            inputs:
              PathtoPublish: '$(BUILD_OUTPUT_FOLDER)'
              ArtifactName: 'orchestrator-portal'
              publishLocation: 'Container'

  - stage: Deploy
    displayName: 'Deploy to Production'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: DeployStaticWebApp
        displayName: 'Deploy to Azure Static Web App'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - download: current
            artifact: orchestrator-portal
            displayName: 'Download build artifacts'

          - script: ls -la $(Pipeline.Workspace)/orchestrator-portal
            displayName: 'List downloaded artifacts'

          - script: |
              npx @azure/static-web-apps-cli deploy $(Pipeline.Workspace)/orchestrator-portal \
                --deployment-token $(AZURE_STATIC_WEB_APPS_API_TOKEN) \
                --env production
            displayName: 'Deploy to Azure Static Web App using SWA CLI'
