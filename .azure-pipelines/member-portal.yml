# Member Portal - CI/CD Pipeline
# Triggers on changes to portal/* directory

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - portal/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: ctn-demo-variables

steps:
  - task: NodeTool@0
    displayName: 'Install Node.js 18.x'
    inputs:
      versionSpec: '18.x'

  - script: |
      node --version
      npm --version
    displayName: 'Display Node and NPM versions'

  - script: |
      cd portal
      npm ci --legacy-peer-deps
    displayName: 'Install dependencies'

  - script: |
      cd portal
      npm run lint
    displayName: 'Run Biome code quality checks'
    continueOnError: true

  - script: |
      cd portal
      npm audit --audit-level=moderate || echo "Security vulnerabilities found - review required"
      npm run security:audit
      npm run security:summary
    displayName: 'Run npm security audit'
    continueOnError: true

  - task: PublishPipelineArtifact@1
    displayName: 'Publish security reports'
    condition: always()
    inputs:
      targetPath: 'portal/reports'
      artifact: 'security-reports-member'
      publishLocation: 'pipeline'
    continueOnError: true

  - script: |
      cd portal
      npm run build
    displayName: 'Build React application'
    env:
      CI: false
      NODE_ENV: production
      REACT_APP_AZURE_CLIENT_ID: 'd3037c11-a541-4f21-8862-8079137a0cde'
      REACT_APP_AZURE_TENANT_ID: '598664e7-725c-4daa-bd1f-89c4ada717ff'
      REACT_APP_REDIRECT_URI: 'https://calm-pebble-043b2db03.1.azurestaticapps.net'
      REACT_APP_API_URL: 'https://func-ctn-demo-asr-dev.azurewebsites.net/api/v1'

  - task: AzureStaticWebApp@0
    displayName: 'Deploy to Azure Static Web Apps'
    inputs:
      app_location: 'portal/build'
      skip_app_build: true
      azure_static_web_apps_api_token: $(AZURE_STATIC_WEB_APPS_API_TOKEN_MEMBER)
