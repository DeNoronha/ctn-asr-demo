# Member Portal - CI/CD Pipeline
# Triggers on changes to portal/* or api/* directories

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - portal/*
      - api/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: ctn-member-portal-variables
  # Key Vault configuration
  - name: keyVaultName
    value: 'kv-ctn-demo-asr-dev'
  - name: azureSubscription
    value: 'Azure-CTN-ASR-ServiceConnection'

steps:
  # Fetch secrets from Azure Key Vault
  - task: AzureKeyVault@2
    displayName: 'Fetch secrets from Key Vault'
    inputs:
      azureSubscription: $(azureSubscription)
      KeyVaultName: $(keyVaultName)
      SecretsFilter: 'AIKIDO-CI-API-KEY,AZURE-STATIC-WEB-APPS-API-TOKEN-MEMBER'
      RunAsPreJob: true

  - task: NodeTool@0
    displayName: 'Install Node.js 20.x'
    inputs:
      versionSpec: '20.x'

  - script: |
      echo "ðŸ” Validating required environment variables..."
      EXIT_CODE=0

      # Check Azure AD configuration
      if [ -z "$(REACT_APP_AAD_CLIENT_ID)" ]; then
        echo "âŒ ERROR: REACT_APP_AAD_CLIENT_ID is not set"
        EXIT_CODE=1
      else
        echo "âœ… REACT_APP_AAD_CLIENT_ID is set"
      fi

      if [ -z "$(REACT_APP_AAD_AUTHORITY)" ]; then
        echo "âŒ ERROR: REACT_APP_AAD_AUTHORITY is not set"
        EXIT_CODE=1
      else
        echo "âœ… REACT_APP_AAD_AUTHORITY is set"
      fi

      if [ -z "$(REACT_APP_AAD_REDIRECT_URI)" ]; then
        echo "âŒ ERROR: REACT_APP_AAD_REDIRECT_URI is not set"
        EXIT_CODE=1
      else
        echo "âœ… REACT_APP_AAD_REDIRECT_URI is set"
      fi

      # Check API configuration
      if [ -z "$(REACT_APP_API_CLIENT_ID)" ]; then
        echo "âŒ ERROR: REACT_APP_API_CLIENT_ID is not set"
        EXIT_CODE=1
      else
        echo "âœ… REACT_APP_API_CLIENT_ID is set"
      fi

      if [ -z "$(REACT_APP_API_BASE_URL)" ]; then
        echo "âŒ ERROR: REACT_APP_API_BASE_URL is not set"
        EXIT_CODE=1
      else
        echo "âœ… REACT_APP_API_BASE_URL is set"
      fi

      # Check deployment token (from Key Vault)
      if [ -z "$(AZURE-STATIC-WEB-APPS-API-TOKEN-MEMBER)" ]; then
        echo "âŒ ERROR: AZURE-STATIC-WEB-APPS-API-TOKEN-MEMBER is not set"
        echo "   (Check Key Vault secret is correctly referenced)"
        EXIT_CODE=1
      else
        echo "âœ… AZURE-STATIC-WEB-APPS-API-TOKEN-MEMBER is set"
      fi

      if [ $EXIT_CODE -ne 0 ]; then
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸš« Build blocked - Missing required variables"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Please ensure the 'ctn-member-portal-variables' variable group contains:"
        echo "  - REACT_APP_AAD_CLIENT_ID"
        echo "  - REACT_APP_AAD_AUTHORITY"
        echo "  - REACT_APP_AAD_REDIRECT_URI"
        echo "  - REACT_APP_API_CLIENT_ID"
        echo "  - REACT_APP_API_BASE_URL"
        echo ""
        echo "And Key Vault contains:"
        echo "  - AZURE-STATIC-WEB-APPS-API-TOKEN-MEMBER"
        echo ""
        exit 1
      fi

      echo ""
      echo "âœ… All required variables validated"
    displayName: 'Validate environment variables'

  - script: |
      node --version
      npm --version
    displayName: 'Display Node and NPM versions'

  - script: |
      cd portal
      npm ci --legacy-peer-deps
    displayName: 'Install dependencies'

  # Biome code quality checks - REPORT ONLY (does not block deployment)
  - script: |
      cd portal
      npm run lint
    displayName: 'Run Biome code quality checks'
    continueOnError: true

  - script: |
      cd portal
      npm audit --audit-level=moderate
      npm run security:audit
      npm run security:summary
    displayName: 'Run npm security audit'
    continueOnError: true

  - script: |
      npm install -g @aikidosec/ci-api-client
      aikido-api-client apikey $(AIKIDO-CI-API-KEY)
    displayName: 'Install Aikido CI client'
    continueOnError: true

  - script: |
      cd portal
      # Fetch origin to ensure we have the reference
      git fetch origin main --depth=50
      # Use the commit before HEAD as base (for comparing current changes)
      BASE_COMMIT=$(git rev-parse HEAD~1)
      HEAD_COMMIT=$(git rev-parse HEAD)
      echo "Scanning commits: $BASE_COMMIT -> $HEAD_COMMIT"
      aikido-api-client scan 1094319 $BASE_COMMIT $HEAD_COMMIT main \
        --minimum-severity-level MEDIUM \
        --fail-on-sast-scan \
        --fail-on-secrets-scan
    displayName: 'Run Aikido Security scan'
    env:
      AIKIDO_CI_API_KEY: $(AIKIDO-CI-API-KEY)
    continueOnError: true

  - task: PublishPipelineArtifact@1
    displayName: 'Publish security reports'
    condition: always()
    inputs:
      targetPath: 'portal/reports'
      artifact: 'security-reports-member'
      publishLocation: 'pipeline'
    continueOnError: true

  # ========================================
  # Build and Deployment Steps
  # Quality checks use continueOnError: true, so builds always run
  # Deployments require successful builds (condition: succeeded())
  # ========================================
  - script: |
      chmod +x scripts/generate-version.sh
      ./scripts/generate-version.sh portal/public
    displayName: 'Generate version.json with build metadata'

  - script: |
      cd portal
      npm run build
    displayName: 'Build React application'
    env:
      CI: false
      NODE_ENV: production
      REACT_APP_AAD_CLIENT_ID: $(REACT_APP_AAD_CLIENT_ID)
      REACT_APP_AAD_AUTHORITY: $(REACT_APP_AAD_AUTHORITY)
      REACT_APP_AAD_REDIRECT_URI: $(REACT_APP_AAD_REDIRECT_URI)
      REACT_APP_API_CLIENT_ID: $(REACT_APP_API_CLIENT_ID)
      REACT_APP_API_BASE_URL: $(REACT_APP_API_BASE_URL)

  - task: AzureStaticWebApp@0
    displayName: 'Deploy to Azure Static Web Apps'
    condition: succeeded()
    inputs:
      app_location: 'portal/build'
      skip_app_build: true
      azure_static_web_apps_api_token: $(AZURE-STATIC-WEB-APPS-API-TOKEN-MEMBER)

  # ========================================
  # API Deployment Steps
  # ========================================
  - script: |
      cd api
      npm ci
    displayName: 'Install API dependencies'

  - script: |
      cd api
      npm run build
    displayName: 'Build API (TypeScript compilation)'

  - task: AzureFunctionApp@2
    displayName: 'Deploy API to Azure Functions'
    condition: succeeded()
    inputs:
      azureSubscription: $(azureSubscription)
      appType: 'functionAppLinux'
      appName: 'func-ctn-demo-asr-dev'
      package: '$(System.DefaultWorkingDirectory)/api'
      runtimeStack: 'NODE|20'
      deploymentMethod: 'zipDeploy'
