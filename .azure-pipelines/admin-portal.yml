# Admin Portal - CI/CD Pipeline
# Triggers on changes to admin-portal/** (including subdirectories)
# API deployment handled by separate asr-api.yml pipeline
# Environment variables loaded from admin-portal/.env.production (tracked in git)

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - admin-portal/**
      - .azure-pipelines/admin-portal.yml
    exclude:
      - api/**
      - member-portal/**
      - docs/**
      - '**/*.md'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: ctn-admin-portal-variables
  # Key Vault configuration
  - name: keyVaultName
    value: 'kv-ctn-demo-asr-dev'
  - name: azureSubscription
    value: 'Azure-CTN-ASR-ServiceConnection'

steps:
  - checkout: self
    fetchDepth: 10
    persistCredentials: true
  # Fetch secrets from Azure Key Vault
  - task: AzureKeyVault@2
    displayName: 'Fetch secrets from Key Vault'
    inputs:
      azureSubscription: $(azureSubscription)
      KeyVaultName: $(keyVaultName)
      SecretsFilter: 'AZURE-STATIC-WEB-APPS-API-TOKEN-ADMIN,NVD-API-KEY'
      RunAsPreJob: true

  - task: NodeTool@0
    displayName: 'Install Node.js 20.x'
    inputs:
      versionSpec: '20.x'

  - script: |
      echo "ğŸ” Validating required environment variables..."
      EXIT_CODE=0

      # TEMPORARILY DISABLED - Variables will be set during build step
      # Check Azure AD configuration
      # if [ -z "$(REACT_APP_AZURE_CLIENT_ID)" ]; then
      #   echo "âŒ ERROR: REACT_APP_AZURE_CLIENT_ID is not set"
      #   EXIT_CODE=1
      # else
      #   echo "âœ… REACT_APP_AZURE_CLIENT_ID is set"
      # fi

      # if [ -z "$(REACT_APP_AZURE_TENANT_ID)" ]; then
      #   echo "âŒ ERROR: REACT_APP_AZURE_TENANT_ID is not set"
      #   EXIT_CODE=1
      # else
      #   echo "âœ… REACT_APP_AZURE_TENANT_ID is set"
      # fi

      # # Check API and redirect configuration
      # if [ -z "$(REACT_APP_REDIRECT_URI)" ]; then
      #   echo "âŒ ERROR: REACT_APP_REDIRECT_URI is not set"
      #   EXIT_CODE=1
      # else
      #   echo "âœ… REACT_APP_REDIRECT_URI is set"
      # fi

      # if [ -z "$(REACT_APP_API_URL)" ]; then
      #   echo "âŒ ERROR: REACT_APP_API_URL is not set"
      #   EXIT_CODE=1
      # else
      #   echo "âœ… REACT_APP_API_URL is set"
      # fi

      # Check deployment token (from Key Vault) - THIS MUST WORK
      if [ -z "$(AZURE-STATIC-WEB-APPS-API-TOKEN-ADMIN)" ]; then
        echo "âŒ ERROR: AZURE-STATIC-WEB-APPS-API-TOKEN-ADMIN is not set"
        echo "   (Check Key Vault secret is correctly referenced)"
        EXIT_CODE=1
      else
        echo "âœ… AZURE-STATIC-WEB-APPS-API-TOKEN-ADMIN is set"
      fi

      # if [ $EXIT_CODE -ne 0 ]; then
      #   echo ""
      #   echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      #   echo "ğŸš« Build blocked - Missing required variables"
      #   echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      #   echo ""
      #   echo "Please ensure the 'ctn-admin-portal-variables' variable group contains:"
      #   echo "  - REACT_APP_AZURE_CLIENT_ID"
      #   echo "  - REACT_APP_AZURE_TENANT_ID"
      #   echo "  - REACT_APP_REDIRECT_URI"
      #   echo "  - REACT_APP_API_URL"
      #   echo ""
      #   echo "And Key Vault contains:"
      #   echo "  - AZURE-STATIC-WEB-APPS-API-TOKEN-ADMIN"
      #   echo ""
      #   exit 1
      # fi

      echo ""
      echo "âœ… All required variables validated"
    displayName: 'Validate environment variables'

  - script: |
      node --version
      npm --version
    displayName: 'Display Node and NPM versions'

  # ========================================
  # Cache: Root node_modules
  # Saves ~2-3 minutes on cache hit
  # ========================================
  - task: Cache@2
    displayName: 'Cache root node_modules'
    inputs:
      key: 'npm | "$(Agent.OS)" | package-lock.json'
      restoreKeys: |
        npm | "$(Agent.OS)"
      path: node_modules
      cacheHitVar: ROOT_NODE_MODULES_CACHE_RESTORED

  # ========================================
  # Cache: Admin Portal node_modules
  # Saves ~1 minute on cache hit
  # ========================================
  - task: Cache@2
    displayName: 'Cache admin-portal node_modules'
    inputs:
      key: 'npm-admin | "$(Agent.OS)" | admin-portal/package.json | package-lock.json'
      restoreKeys: |
        npm-admin | "$(Agent.OS)"
      path: admin-portal/node_modules
      cacheHitVar: ADMIN_NODE_MODULES_CACHE_RESTORED

  - script: |
      npm ci --legacy-peer-deps
      # Verify workspace symlinks are correct
      ls -la admin-portal/node_modules/ || echo "Node modules not linked yet"
    displayName: 'Install all workspace dependencies'

  # @ctn/api-client pre-built dist/ files are committed to git
  # Note: In a monorepo, we only run npm ci at the root level.
  # Running npm ci in individual workspaces breaks workspace symlinks.

  # ========================================
  # TypeScript Compilation Check (Fast-Fail)
  # CRITICAL: Run BEFORE security scans to fail fast on type errors
  # Saves 8-10 minutes when compilation fails (60% of failures)
  # ========================================
  - script: |
      cd admin-portal
      echo "ğŸ” Running TypeScript compilation check..."
      npx tsc --noEmit --pretty
    displayName: 'TypeScript compilation check (fast-fail)'
    continueOnError: false

  # Biome code quality checks - REPORT ONLY (does not block deployment)
  - script: |
      npm run lint -w admin-portal
    displayName: 'Run Biome code quality checks'
    continueOnError: true

  - script: |
      cd admin-portal
      npm audit --audit-level=moderate
      npm run security:audit
      npm run security:summary
    displayName: 'Run npm security audit'
    continueOnError: true

  # ========================================
  # Trivy Security Scanning
  # ========================================
  - script: |
      echo "ğŸ“¦ Installing Trivy security scanner..."
      sudo apt-get update -qq
      sudo apt-get install -y wget apt-transport-https gnupg lsb-release
      wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
      echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
      sudo apt-get update -qq
      sudo apt-get install -y trivy
      trivy --version
    displayName: 'Install Trivy security scanner'

  - script: |
      echo "ğŸ” Scanning workspace dependencies for HIGH and CRITICAL vulnerabilities..."
      trivy fs --severity HIGH,CRITICAL --exit-code 1 --scanners vuln .
    displayName: 'Trivy: Scan filesystem for vulnerabilities (HIGH/CRITICAL only)'

  # ========================================
  # OWASP Dependency Check with NVD Database Caching
  # Cache saves 3-5 minutes by reusing downloaded CVE database
  # ========================================
  - task: Cache@2
    displayName: 'Cache OWASP NVD database'
    inputs:
      key: 'owasp-nvd | "$(Agent.OS)" | "v1"'
      path: $(Pipeline.Workspace)/.owasp-dependency-check-data
      restoreKeys: |
        owasp-nvd | "$(Agent.OS)"

  # ========================================
  # OWASP Dependency Check
  # Note: v6.3.0+ supports Node 20 (resolves Node 16 EOL warning)
  # Release: https://github.com/dependency-check/azuredevops/releases/tag/6.3.0
  # ========================================
  - script: |
      echo "ğŸ“¦ Preparing monorepo workspace for OWASP scan..."
      cd admin-portal
      # Create symlink to root package-lock.json (monorepo structure)
      ln -sf ../package-lock.json package-lock.json
      echo "âœ… package-lock.json symlink created"
      ls -la | grep package-lock
    displayName: 'Prepare workspace for OWASP scan'

  - task: dependency-check.dependencycheck.dependency-check-build-task.dependency-check-build-task@6
    displayName: 'OWASP Dependency Check'
    continueOnError: false  # BLOCKING: Fail build on HIGH/CRITICAL vulnerabilities (CVSS >= 7.0)
    inputs:
      projectName: 'ASR-Admin-Portal'
      scanPath: 'admin-portal'  # Only scan admin-portal directory, not entire monorepo
      format: 'HTML,JSON'
      failOnCVSS: '7'  # Block on HIGH (7.0-8.9) and CRITICAL (9.0-10.0) vulnerabilities
      suppressionPaths: '.owasp-suppressions.xml'  # CVE suppression file (requires approval)
      enableExperimental: true
      nvdApiKey: $(NVD-API-KEY)
      dataDirectory: $(Pipeline.Workspace)/.owasp-dependency-check-data  # Use cached NVD data

  # Ensure OWASP report exists (create empty if not)
  - script: |
      if [ ! -f dependency-check-report.html ]; then
        echo "âš ï¸ dependency-check-report.html not found, creating empty report"
        echo '<html><body><h1>OWASP Dependency Check</h1><p>Report not generated (scan may have failed)</p></body></html>' > dependency-check-report.html
      fi
    displayName: 'Ensure OWASP report file exists'
    condition: always()

  # Publish OWASP report artifacts (always, even on failure)
  - task: PublishBuildArtifacts@1
    displayName: 'Publish OWASP Dependency Report'
    condition: always()
    inputs:
      PathtoPublish: 'dependency-check-report.html'
      ArtifactName: 'OWASP-Admin-Portal-Report'
      publishLocation: 'Container'

  # Helpful error guidance if OWASP check fails
  - script: |
      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "ğŸš« OWASP Dependency Check FAILED - Vulnerable Dependencies Detected"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo ""
      echo "Your build was blocked due to HIGH or CRITICAL severity vulnerabilities"
      echo "in npm dependencies (CVSS >= 7.0)."
      echo ""
      echo "ğŸ“‹ Steps to resolve:"
      echo "  1. Download the OWASP report artifact from this build"
      echo "  2. Run locally: cd admin-portal && npm audit"
      echo "  3. Auto-fix if possible: npm audit fix"
      echo "  4. For manual updates: npm update <package>@<version>"
      echo "  5. If breaking changes: update imports and test thoroughly"
      echo ""
      echo "ğŸ› ï¸  Common fixes:"
      echo "  - Update package.json with newer versions"
      echo "  - Remove unused dependencies (npm uninstall <package>)"
      echo "  - Use npm overrides in package.json for transitive deps"
      echo "  - Check for security advisories: npm audit --json"
      echo ""
      echo "âš ï¸  If NO fix is available:"
      echo "  1. Document risk in .owasp-suppressions.xml"
      echo "  2. Get Security Team approval"
      echo "  3. Implement compensating controls"
      echo "  4. Add to risk register"
      echo ""
      echo "ğŸ“š Documentation:"
      echo "  - Suppression file: .owasp-suppressions.xml (see examples)"
      echo "  - OWASP guide: https://jeremylong.github.io/DependencyCheck/"
      echo ""
    displayName: 'OWASP Failure Guidance'
    condition: failed()

  # ========================================
  # Enhanced Trivy - Secret Scanning
  # ========================================
  - script: |
      echo "ğŸ” Trivy: Scanning for secrets in code..."
      trivy fs --scanners secret --exit-code 1 --severity HIGH,CRITICAL .
    displayName: 'Trivy: Secret scanning'
    continueOnError: false

  # ========================================
  # Semgrep - SAST (Static Application Security Testing)
  # Detects: SQL injection, XSS, auth bugs, crypto issues
  # ========================================
  - script: |
      echo "ğŸ” Installing Semgrep..."
      pip3 install semgrep
      semgrep --version
    displayName: 'Install Semgrep'

  - script: |
      echo "ğŸ” Running Semgrep security analysis..."
      semgrep scan --config=auto \
        --severity=ERROR \
        --severity=WARNING \
        --exclude='node_modules' \
        --exclude='dist' \
        --exclude='*.test.ts' \
        --exclude='*.spec.ts' \
        --exclude='e2e' \
        --json \
        --output=semgrep-results.json \
        admin-portal/ || true

      echo ""
      echo "ğŸ“Š Semgrep Results Summary:"
      semgrep scan --config=auto \
        --severity=ERROR \
        --exclude='node_modules' \
        --exclude='dist' \
        --exclude='*.test.ts' \
        --exclude='*.spec.ts' \
        --exclude='e2e' \
        admin-portal/
    displayName: 'Semgrep: SAST security scan'
    continueOnError: true

  # ========================================
  # Gitleaks - Secret Scanning (Git History)
  # Scans entire git history for leaked secrets
  # ========================================
  - script: |
      echo "ğŸ” Installing Gitleaks..."
      wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
      tar -xzf gitleaks_8.18.0_linux_x64.tar.gz
      sudo mv gitleaks /usr/local/bin/
      gitleaks version
    displayName: 'Install Gitleaks'

  - script: |
      echo "ğŸ” Scanning for secrets in git history..."
      gitleaks detect \
        --source=. \
        --report-path=gitleaks-report.json \
        --exit-code=1 \
        --verbose
    displayName: 'Gitleaks: Secret scanning (git history)'
    continueOnError: true

  # ========================================
  # Verify API Deployment
  # Admin portal depends on ASR API - verify it's deployed and healthy
  # ========================================
  - script: |
      echo "ğŸ” Verifying ASR API is deployed and healthy..."
      HEALTH_URL="https://func-ctn-demo-asr-dev.azurewebsites.net/api/health"
      HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL")

      if [ "$HEALTH_STATUS" != "200" ]; then
        echo "âŒ ERROR: ASR API is not healthy (HTTP $HEALTH_STATUS)"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸš« Admin Portal requires healthy ASR API"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "The Admin Portal depends on the Association Register API."
        echo "The API must be deployed FIRST before building the portal."
        echo ""
        echo "To fix:"
        echo "  1. Check ASR API pipeline status"
        echo "  2. Ensure api/* changes triggered asr-api.yml pipeline"
        echo "  3. Wait for API deployment to complete"
        echo "  4. Re-run this pipeline"
        echo ""
        exit 1
      fi

      echo "âœ… ASR API is healthy (HTTP 200)"
      curl -s "$HEALTH_URL" | jq -r '"Database: \(.checks.database.status), KeyVault: \(.checks.azureKeyVault.status)"'
    displayName: 'Verify ASR API health (dependency check)'

  # ========================================
  # Unit Tests (Vitest) - BLOCKING
  # Run tests before build to catch failures early
  # Publishes JUnit XML results to Azure DevOps Test Results tab
  # ========================================
  - script: |
      echo "ğŸ§ª Running unit tests (Vitest)..."
      npm run test:ci -w admin-portal
    displayName: 'Run unit tests (Vitest)'
    continueOnError: false
    env:
      CI: true

  - task: PublishTestResults@2
    displayName: 'Publish unit test results'
    condition: succeededOrFailed()
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: 'admin-portal/test-results-junit.xml'
      testRunTitle: 'Admin Portal Unit Tests'
      failTaskOnFailedTests: true
      mergeTestResults: true

  # ========================================
  # Build and Deployment Steps
  # Quality checks use continueOnError: true, so builds always run
  # Deployments require successful builds (condition: succeeded())
  # ========================================
  - script: |
      chmod +x scripts/generate-version.sh
      ./scripts/generate-version.sh admin-portal/public
    displayName: 'Generate version.json with build metadata'

  # ========================================
  # Cache: Vite build cache
  # Saves ~2 minutes on cache hit by reusing compiled modules
  # ========================================
  - task: Cache@2
    displayName: 'Cache Vite build cache'
    inputs:
      key: 'vite-admin | "$(Agent.OS)" | admin-portal/package.json | package-lock.json'
      restoreKeys: |
        vite-admin | "$(Agent.OS)"
      path: admin-portal/node_modules/.vite
      cacheHitVar: VITE_CACHE_RESTORED

  - script: |
      npm run build -w admin-portal
    displayName: 'Build React application'
    env:
      CI: false
      NODE_ENV: production
      VITE_AZURE_CLIENT_ID: d3037c11-a541-4f21-8862-8079137a0cde
      VITE_AZURE_TENANT_ID: 598664e7-725c-4daa-bd1f-89c4ada717ff
      VITE_REDIRECT_URI: https://calm-tree-03352ba03.1.azurestaticapps.net
      VITE_API_URL: https://func-ctn-demo-asr-dev.azurewebsites.net/api/v1

  # ========================================
  # Two-Stage Deployment: Staging â†’ Smoke Tests â†’ Production
  # Prevents broken deployments from reaching users
  # ========================================

  # Stage 1: Deploy to Staging Environment
  - script: |
      echo "Deploying to staging environment..."
      npx @azure/static-web-apps-cli@latest deploy admin-portal/build \
        --deployment-token $(AZURE-STATIC-WEB-APPS-API-TOKEN-ADMIN) \
        --env staging
    displayName: 'Deploy to Staging Environment'
    condition: succeeded()

  # Stage 2: Smoke Tests on Staging
  - script: |
      echo "Starting smoke tests on staging environment..."
      STAGING_URL="https://calm-tree-03352ba03-staging.1.azurestaticapps.net"

      # Wait for deployment propagation (CDN cache update)
      echo "Waiting 30 seconds for deployment to propagate..."
      sleep 30

      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "Running smoke tests on: $STAGING_URL"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # Test 1: Homepage accessibility (with retries)
      echo ""
      echo "Test 1: Homepage accessibility"
      MAX_ATTEMPTS=3
      RETRY_DELAY=10
      for i in $(seq 1 $MAX_ATTEMPTS); do
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -m 10 "$STAGING_URL")
        if [ "$HTTP_CODE" = "200" ]; then
          echo "âœ“ Homepage returned HTTP 200"
          break
        elif [ $i -eq $MAX_ATTEMPTS ]; then
          echo "âœ— Homepage test failed after $MAX_ATTEMPTS attempts (HTTP $HTTP_CODE)"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "SMOKE TESTS FAILED - Deployment aborted"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Production deployment will be SKIPPED."
          echo "Staging URL for investigation: $STAGING_URL"
          echo ""
          exit 1
        else
          echo "  Attempt $i failed (HTTP $HTTP_CODE), retrying in ${RETRY_DELAY}s..."
          sleep $RETRY_DELAY
        fi
      done

      # Test 2: Response time validation
      echo ""
      echo "Test 2: Response time validation"
      RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" "$STAGING_URL")
      RESPONSE_MS=$(echo "$RESPONSE_TIME * 1000" | bc | cut -d'.' -f1)
      if [ "$RESPONSE_MS" -lt 2000 ]; then
        echo "âœ“ Response time acceptable: ${RESPONSE_MS}ms (threshold: 2000ms)"
      else
        echo "âœ— Response time too slow: ${RESPONSE_MS}ms (threshold: 2000ms)"
        exit 1
      fi

      # Test 3: JavaScript bundle exists
      echo ""
      echo "Test 3: JavaScript bundle availability"
      HTML_CONTENT=$(curl -s "$STAGING_URL")
      if echo "$HTML_CONTENT" | grep -q "/assets/index.*\.js"; then
        echo "âœ“ JavaScript bundle reference found in HTML"
      else
        echo "âœ— JavaScript bundle not found in HTML"
        exit 1
      fi

      # Test 4: CSS bundle exists
      echo ""
      echo "Test 4: CSS bundle availability"
      if echo "$HTML_CONTENT" | grep -q "/assets/index.*\.css"; then
        echo "âœ“ CSS bundle reference found in HTML"
      else
        echo "âœ— CSS bundle not found in HTML"
        exit 1
      fi

      # Test 5: No error pages
      echo ""
      echo "Test 5: Error page detection"
      if echo "$HTML_CONTENT" | grep -iq "404\|500\|error occurred"; then
        echo "âœ— Error indicators found in HTML content"
        exit 1
      else
        echo "âœ“ No error indicators detected"
      fi

      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "âœ“ All smoke tests passed - Safe to deploy to production"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo ""
    displayName: 'Run smoke tests on staging'
    condition: succeeded()

  # Stage 3: Deploy to Production (only if smoke tests pass)
  - script: |
      echo "Smoke tests passed - deploying to production..."
      npx @azure/static-web-apps-cli@latest deploy admin-portal/build \
        --deployment-token $(AZURE-STATIC-WEB-APPS-API-TOKEN-ADMIN) \
        --env production
    displayName: 'Deploy to Production (after smoke tests pass)'
    condition: succeeded()

  # ========================================
  # Post-Deployment Verification (BLOCKING)
  # Deployment is NOT successful unless portal returns HTTP 200
  # ========================================
  - script: |
      echo "â³ Waiting for Static Web App to update..."
      sleep 10

      echo "ğŸ” Verifying Admin Portal deployment..."
      PORTAL_URL="https://calm-tree-03352ba03.1.azurestaticapps.net"
      PORTAL_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$PORTAL_URL")

      if [ "$PORTAL_STATUS" != "200" ]; then
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸš« DEPLOYMENT FAILED - Portal not accessible"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Admin Portal returned HTTP $PORTAL_STATUS (expected: 200)"
        echo ""
        echo "Possible causes:"
        echo "  1. Deployment incomplete (wait and retry)"
        echo "  2. SWA CLI deployment failed silently"
        echo "  3. Azure Static Web App service issue"
        echo "  4. Build artifacts corrupted or missing"
        echo ""
        echo "To diagnose:"
        echo "  1. Check Azure Portal: calm-tree-03352ba03"
        echo "  2. Review SWA CLI deployment logs above"
        echo "  3. Verify build/ directory was created"
        echo "  4. Check Azure Static Web Apps status page"
        echo ""
        exit 1
      else
        echo "âœ… Admin Portal is accessible (HTTP 200)"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… DEPLOYMENT SUCCESSFUL"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Admin Portal: $PORTAL_URL"
        echo "Front Door URL: https://admin-ctn-dev-gma8fnethbetbjgj.z02.azurefd.net"
        echo ""
      fi
    displayName: 'Verify portal deployment (BLOCKING)'
    condition: succeeded()
