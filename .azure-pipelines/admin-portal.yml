# Admin Portal - CI/CD Pipeline
# Triggers on changes to web/* directory

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - web/*

# NOTE: Pipeline requires MS-hosted parallelism grant from Microsoft
# Request form: https://aka.ms/azpipelines-parallelism-request
# Pipeline is correctly configured and will work once parallelism is granted
pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: ctn-demo-variables  # Reference variable group
  # Production environment variables
  - name: REACT_APP_AZURE_CLIENT_ID
    value: 'd3037c11-a541-4f21-8862-8079137a0cde'
  - name: REACT_APP_AZURE_TENANT_ID
    value: '598664e7-725c-4daa-bd1f-89c4ada717ff'
  - name: REACT_APP_REDIRECT_URI
    value: 'https://calm-tree-03352ba03.1.azurestaticapps.net'
  - name: REACT_APP_API_URL
    value: 'https://func-ctn-demo-asr-dev.azurewebsites.net/api/v1'
  - name: workingDirectory
    value: '$(System.DefaultWorkingDirectory)/web'

stages:
  - stage: Build
    displayName: 'Build Admin Portal'
    jobs:
      - job: BuildJob
        displayName: 'Build React App'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js 18.x'
            inputs:
              versionSpec: '18.x'

          - script: |
              node --version
              npm --version
            displayName: 'Display Node and NPM versions'

          - script: |
              cd $(workingDirectory)
              npm ci --legacy-peer-deps
            displayName: 'Install dependencies (npm ci)'

          - script: |
              cd $(workingDirectory)
              npm run build
            displayName: 'Build React application'
            env:
              CI: false
              NODE_ENV: production
              REACT_APP_AZURE_CLIENT_ID: $(REACT_APP_AZURE_CLIENT_ID)
              REACT_APP_AZURE_TENANT_ID: $(REACT_APP_AZURE_TENANT_ID)
              REACT_APP_REDIRECT_URI: $(REACT_APP_REDIRECT_URI)
              REACT_APP_API_URL: $(REACT_APP_API_URL)

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Build Artifacts'
            inputs:
              targetPath: '$(workingDirectory)/build'
              artifact: 'admin-portal-build'
              publishLocation: 'pipeline'

  - stage: Deploy
    displayName: 'Deploy to Azure'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: DeployJob
        displayName: 'Deploy to Static Web App'
        steps:
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Build Artifacts'
            inputs:
              artifactName: 'admin-portal-build'
              targetPath: '$(Pipeline.Workspace)/build'

          - task: AzureStaticWebApp@0
            displayName: 'Deploy to Azure Static Web Apps'
            inputs:
              app_location: '$(Pipeline.Workspace)/build'
              skip_app_build: true
              azure_static_web_apps_api_token: $(AZURE_STATIC_WEB_APPS_API_TOKEN)
