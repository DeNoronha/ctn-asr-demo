# ASR API Pipeline - Association Register Backend
# Single source of truth for API deployment
# Serves: Admin Portal + Member Portal (tightly coupled)
# Does NOT trigger: DocuFlow, Orchestrator, Documentation (independent)
#
# Triggers on API changes only, then cascades to dependent portals

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - api/**
      - .azure-pipelines/asr-api.yml

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: azureSubscription
    value: 'Azure-CTN-ASR-ServiceConnection'
  - name: functionAppName
    value: 'func-ctn-demo-asr-dev'

stages:
  - stage: BuildAndDeploy
    displayName: 'Build and Deploy ASR API'
    jobs:
      - job: DeployAPI
        displayName: 'Deploy Association Register API'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js 20.x'
            inputs:
              versionSpec: '20.x'

          # Fetch NVD API Key from Azure Key Vault
          - task: AzureKeyVault@2
            displayName: 'Fetch NVD API Key from Key Vault'
            inputs:
              azureSubscription: $(azureSubscription)
              KeyVaultName: 'kv-ctn-demo-asr-dev'
              SecretsFilter: 'NVD-API-KEY'
              RunAsPreJob: false

          - script: |
              node --version
              npm --version
            displayName: 'Display Node and NPM versions'

          # ========================================
          # Cache: Root node_modules
          # Saves ~2-3 minutes on cache hit
          # ========================================
          - task: Cache@2
            displayName: 'Cache root node_modules'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: node_modules
              cacheHitVar: ROOT_NODE_MODULES_CACHE_RESTORED

          # ========================================
          # Cache: API node_modules
          # Saves ~3 minutes on cache hit (50+ dependencies)
          # ========================================
          - task: Cache@2
            displayName: 'Cache API node_modules'
            inputs:
              key: 'npm-api | "$(Agent.OS)" | api/package.json | api/package-lock.json'
              restoreKeys: |
                npm-api | "$(Agent.OS)"
              path: api/node_modules
              cacheHitVar: API_NODE_MODULES_CACHE_RESTORED

          # Install dependencies at root level (monorepo)
          - script: |
              npm ci --legacy-peer-deps
            displayName: 'Install monorepo dependencies'

          # Install API-specific dependencies
          - script: |
              cd api
              npm ci
            displayName: 'Install API dependencies'

          # Build API (TypeScript compilation)
          - script: |
              cd api
              npm run build
              ls -la dist/
            displayName: 'Build API (TypeScript compilation)'

          # ========================================
          # Trivy Security Scanning
          # ========================================
          - script: |
              echo "üì¶ Installing Trivy security scanner..."
              sudo apt-get update -qq
              sudo apt-get install -y wget apt-transport-https gnupg lsb-release
              wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
              echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
              sudo apt-get update -qq
              sudo apt-get install -y trivy
              trivy --version
            displayName: 'Install Trivy security scanner'

          - script: |
              echo "üîç Scanning workspace dependencies for HIGH and CRITICAL vulnerabilities..."
              trivy fs --severity HIGH,CRITICAL --exit-code 1 --scanners vuln .
            displayName: 'Trivy: Scan filesystem for vulnerabilities (HIGH/CRITICAL only)'

          # ========================================
          # OWASP Dependency Check
          # Note: v6.3.0+ supports Node 20 (resolves Node 16 EOL warning)
          # Release: https://github.com/dependency-check/azuredevops/releases/tag/6.3.0
          # ========================================
          - task: dependency-check.dependencycheck.dependency-check-build-task.dependency-check-build-task@6
            displayName: 'OWASP Dependency Check'
            continueOnError: true
            inputs:
              projectName: 'ASR-API'
              scanPath: '.'
              format: 'HTML,JSON'
              failOnCVSS: '7'
              enableExperimental: true
              nvdApiKey: $(NVD-API-KEY)

          # ========================================
          # Enhanced Trivy - Secret Scanning
          # ========================================
          - script: |
              echo "üîê Trivy: Scanning for secrets in code..."
              trivy fs --scanners secret --exit-code 1 --severity HIGH,CRITICAL .
            displayName: 'Trivy: Secret scanning'
            continueOnError: false

          # ========================================
          # Semgrep - SAST (Static Application Security Testing)
          # Detects: SQL injection, XSS, auth bugs, crypto issues
          # ========================================
          - script: |
              echo "üîç Installing Semgrep..."
              pip3 install semgrep
              semgrep --version
            displayName: 'Install Semgrep'

          - script: |
              echo "üîç Running Semgrep security analysis..."
              semgrep scan --config=auto \
                --severity=ERROR \
                --severity=WARNING \
                --exclude='node_modules' \
                --exclude='dist' \
                --exclude='*.test.ts' \
                --exclude='*.spec.ts' \
                --json \
                --output=semgrep-results.json \
                . || true

              echo ""
              echo "üìä Semgrep Results Summary:"
              semgrep scan --config=auto \
                --severity=ERROR \
                --exclude='node_modules' \
                --exclude='dist' \
                --exclude='*.test.ts' \
                --exclude='*.spec.ts' \
                .
            displayName: 'Semgrep: SAST security scan'
            continueOnError: true

          # ========================================
          # Gitleaks - Secret Scanning (Git History)
          # Scans entire git history for leaked secrets
          # ========================================
          - script: |
              echo "üîê Installing Gitleaks..."
              wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
              tar -xzf gitleaks_8.18.0_linux_x64.tar.gz
              sudo mv gitleaks /usr/local/bin/
              gitleaks version
            displayName: 'Install Gitleaks'

          - script: |
              echo "üîê Scanning for secrets in git history..."
              gitleaks detect \
                --source=. \
                --report-path=gitleaks-report.json \
                --exit-code=1 \
                --verbose
            displayName: 'Gitleaks: Secret scanning (git history)'
            continueOnError: true

          # Verify essential functions are compiled
          - script: |
              cd api
              if [ ! -f "dist/index.js" ]; then
                echo "‚ùå ERROR: dist/index.js not found"
                exit 1
              fi
              if [ ! -d "dist/functions" ]; then
                echo "‚ùå ERROR: dist/functions directory not found"
                exit 1
              fi
              echo "‚úÖ Build artifacts verified"
            displayName: 'Verify build artifacts'

          # Install Azure Functions Core Tools
          - script: |
              echo "üì¶ Installing Azure Functions Core Tools..."
              curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
              sudo mv microsoft.gpg /etc/apt/trusted.gpg.d/microsoft.gpg
              sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/microsoft-ubuntu-$(lsb_release -cs)-prod $(lsb_release -cs) main" > /etc/apt/sources.list.d/dotnetdev.list'
              sudo apt-get update
              sudo apt-get install azure-functions-core-tools-4 -y
              func --version
            displayName: 'Install Azure Functions Core Tools'

          # Authenticate to Azure and deploy using func CLI
          - task: AzureCLI@2
            displayName: 'Deploy API using Azure Functions Core Tools'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                cd api
                echo "üöÄ Deploying to $(functionAppName) using func CLI..."
                echo "   Using same method as successful manual deployment"

                # Deploy using Azure Functions Core Tools (matches manual deployment)
                func azure functionapp publish $(functionAppName) --typescript --build remote

                echo "‚úÖ Deployment command completed"

          # Wait and verify deployment
          - script: |
              echo "‚è≥ Waiting for Function App to warm up..."
              sleep 20

              echo "üîç Verifying API deployment..."
              HEALTH_URL="https://$(functionAppName).azurewebsites.net/api/health"

              # Retry health check up to 5 times
              for i in {1..5}; do
                echo "Attempt $i of 5..."
                HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL")

                if [ "$HEALTH_STATUS" = "200" ]; then
                  echo "‚úÖ API health check passed (HTTP 200)"

                  # Get and display health details
                  curl -s "$HEALTH_URL" | jq '.'

                  # Extract commit hash from deployment
                  GIT_COMMIT=$(git rev-parse --short HEAD)
                  echo "üì¶ Deployed commit: $GIT_COMMIT"
                  echo "##vso[task.setvariable variable=ApiCommitHash;isOutput=true]$GIT_COMMIT"

                  exit 0
                fi

                echo "‚ö†Ô∏è  Health check returned HTTP $HEALTH_STATUS, retrying in 10s..."
                sleep 10
              done

              echo "‚ùå API health check failed after 5 attempts"
              echo "   URL: $HEALTH_URL"
              echo "   Last status: $HEALTH_STATUS"
              exit 1
            displayName: 'Verify API deployment health'
            name: VerifyDeployment

          # List deployed functions
          - script: |
              echo "üìã Listing deployed functions..."
              az functionapp function list \
                --name $(functionAppName) \
                --resource-group rg-ctn-demo-asr-dev \
                --output table || echo "‚ö†Ô∏è  Could not list functions (non-critical)"
            displayName: 'List deployed functions'
            continueOnError: true

  # Trigger downstream portal pipelines (Admin + Member only)
  - stage: TriggerPortals
    displayName: 'Trigger Portal Builds'
    dependsOn: BuildAndDeploy
    condition: succeeded()
    jobs:
      - job: TriggerAdminPortal
        displayName: 'Trigger Admin Portal Pipeline'
        steps:
          - task: AzureCLI@2
            displayName: 'Trigger Admin Portal build'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "üöÄ Triggering Admin Portal pipeline..."
                az pipelines run \
                  --org https://dev.azure.com/ctn-demo \
                  --project ASR \
                  --name "Association-Register-Admin" \
                  --branch main
                echo "‚úÖ Admin Portal pipeline triggered"

      - job: TriggerMemberPortal
        displayName: 'Trigger Member Portal Pipeline'
        steps:
          - task: AzureCLI@2
            displayName: 'Trigger Member Portal build'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "üöÄ Triggering Member Portal pipeline..."
                az pipelines run \
                  --org https://dev.azure.com/ctn-demo \
                  --project ASR \
                  --name "Association-Register-Member" \
                  --branch main
                echo "‚úÖ Member Portal pipeline triggered"
