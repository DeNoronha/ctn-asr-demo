# ASR API Pipeline - Association Register Backend
# Single source of truth for API deployment
# Serves: Admin Portal + Member Portal (tightly coupled)
# Does NOT trigger: DocuFlow, Orchestrator, Documentation (independent)
#
# Triggers on API changes only, then cascades to dependent portals

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - api/**
      - .azure-pipelines/asr-api.yml

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: azureSubscription
    value: 'Azure-CTN-ASR-ServiceConnection'
  - name: functionAppName
    value: 'func-ctn-demo-asr-dev'

stages:
  - stage: BuildAndDeploy
    displayName: 'Build and Deploy ASR API'
    jobs:
      - job: DeployAPI
        displayName: 'Deploy Association Register API'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js 20.x'
            inputs:
              versionSpec: '20.x'

          # Fetch NVD API Key from Azure Key Vault
          - task: AzureKeyVault@2
            displayName: 'Fetch NVD API Key from Key Vault'
            inputs:
              azureSubscription: $(azureSubscription)
              KeyVaultName: 'kv-ctn-demo-asr-dev'
              SecretsFilter: 'NVD-API-KEY'
              RunAsPreJob: true

          - script: |
              node --version
              npm --version
            displayName: 'Display Node and NPM versions'

          # ========================================
          # Cache: Root node_modules
          # Saves ~2-3 minutes on cache hit
          # ========================================
          - task: Cache@2
            displayName: 'Cache root node_modules'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: node_modules
              cacheHitVar: ROOT_NODE_MODULES_CACHE_RESTORED

          # ========================================
          # Cache: API node_modules
          # Saves ~3 minutes on cache hit (50+ dependencies)
          # ========================================
          - task: Cache@2
            displayName: 'Cache API node_modules'
            inputs:
              key: 'npm-api | "$(Agent.OS)" | api/package.json | package-lock.json'
              restoreKeys: |
                npm-api | "$(Agent.OS)"
              path: api/node_modules
              cacheHitVar: API_NODE_MODULES_CACHE_RESTORED

          # Install dependencies at root level (monorepo)
          - script: |
              npm ci --legacy-peer-deps
            displayName: 'Install monorepo dependencies'

          # Install API-specific dependencies
          - script: |
              cd api
              npm ci
            displayName: 'Install API dependencies'

          # Build API (TypeScript compilation)
          - script: |
              cd api
              npm run build
              ls -la dist/
            displayName: 'Build API (TypeScript compilation)'

          # ========================================
          # Trivy Security Scanning
          # ========================================
          - script: |
              echo "ğŸ“¦ Installing Trivy security scanner..."
              sudo apt-get update -qq
              sudo apt-get install -y wget apt-transport-https gnupg lsb-release
              wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
              echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
              sudo apt-get update -qq
              sudo apt-get install -y trivy
              trivy --version
            displayName: 'Install Trivy security scanner'

          - script: |
              echo "ğŸ” Scanning workspace dependencies for HIGH and CRITICAL vulnerabilities..."
              trivy fs --severity HIGH,CRITICAL --exit-code 1 --scanners vuln .
            displayName: 'Trivy: Scan filesystem for vulnerabilities (HIGH/CRITICAL only)'

          # ========================================
          # OWASP Dependency Check - TEMPORARILY DISABLED
          # Reason: Database connection pool errors with NVD API
          # TODO: Re-enable after fixing OWASP config
          # ========================================
          # - task: Cache@2
          #   displayName: 'Cache OWASP NVD database'
          #   inputs:
          #     key: 'owasp-nvd | "$(Agent.OS)" | "v1"'
          #     path: $(Pipeline.Workspace)/.owasp-dependency-check-data
          #     restoreKeys: |
          #       owasp-nvd | "$(Agent.OS)"

          # - task: dependency-check.dependencycheck.dependency-check-build-task.dependency-check-build-task@6
          #   displayName: 'OWASP Dependency Check'
          #   continueOnError: true
          #   inputs:
          #     projectName: 'ASR-API'
          #     scanPath: '.'
          #     format: 'HTML,JSON'
          #     failOnCVSS: '7'
          #     enableExperimental: true
          #     nvdApiKey: $(NVD-API-KEY)
          #     dataDirectory: $(Pipeline.Workspace)/.owasp-dependency-check-data

          # ========================================
          # Enhanced Trivy - Secret Scanning
          # ========================================
          - script: |
              echo "ğŸ” Trivy: Scanning for secrets in code..."
              trivy fs --scanners secret --exit-code 1 --severity HIGH,CRITICAL .
            displayName: 'Trivy: Secret scanning'
            continueOnError: false

          # ========================================
          # Semgrep - SAST (Static Application Security Testing)
          # Detects: SQL injection, XSS, auth bugs, crypto issues
          # Blocks build on ERROR severity, warns on WARNING/INFO
          # ========================================
          - script: |
              echo "ğŸ” Installing Semgrep..."
              pip3 install semgrep
              semgrep --version
            displayName: 'Install Semgrep'

          # Run full scan and generate JSON report
          - script: |
              echo "ğŸ” Running Semgrep security analysis..."
              semgrep scan --config=auto \
                --config=.semgrep/ignore.yml \
                --severity=ERROR \
                --severity=WARNING \
                --exclude='node_modules' \
                --exclude='dist' \
                --exclude='*.test.ts' \
                --exclude='*.spec.ts' \
                --exclude='e2e' \
                --json \
                --output=semgrep-results.json \
                api/ || true

              echo ""
              echo "ğŸ“Š Semgrep Results Summary:"
              semgrep scan --config=auto \
                --config=.semgrep/ignore.yml \
                --severity=ERROR \
                --severity=WARNING \
                --exclude='node_modules' \
                --exclude='dist' \
                --exclude='*.test.ts' \
                --exclude='*.spec.ts' \
                --exclude='e2e' \
                api/ || true
            displayName: 'Semgrep: SAST security scan'
            continueOnError: true

          # Parse results and block on ERROR severity
          - script: |
              if [ ! -f semgrep-results.json ]; then
                echo "âš ï¸ Semgrep results file not found"
                exit 0
              fi

              # Count findings by severity
              ERROR_COUNT=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' semgrep-results.json)
              WARNING_COUNT=$(jq '[.results[] | select(.extra.severity == "WARNING")] | length' semgrep-results.json)
              INFO_COUNT=$(jq '[.results[] | select(.extra.severity == "INFO")] | length' semgrep-results.json)

              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ“Š Semgrep SAST Security Results"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ”´ ERROR:   $ERROR_COUNT (blocking)"
              echo "ğŸŸ¡ WARNING: $WARNING_COUNT (non-blocking)"
              echo "ğŸ”µ INFO:    $INFO_COUNT (informational)"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

              # Block build on ERROR severity
              if [ "$ERROR_COUNT" -gt 0 ]; then
                echo ""
                echo "ğŸš« BUILD BLOCKED - ERROR severity vulnerabilities detected"
                echo ""
                echo "Security vulnerabilities found:"
                echo ""
                jq -r '.results[] | select(.extra.severity == "ERROR") | "  ğŸ”´ \(.check_id)\n     File: \(.path):\(.start.line)\n     Message: \(.extra.message)\n"' semgrep-results.json
                echo ""
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "ğŸ› ï¸  How to Fix:"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "1. Download semgrep-results.json from build artifacts"
                echo "2. Run locally: pip install semgrep && semgrep scan --config=auto api/"
                echo "3. Review each finding and apply recommended fixes"
                echo "4. Re-commit after fixes and re-run pipeline"
                echo ""
                echo "Common Semgrep ERROR findings and fixes:"
                echo "  â€¢ SQL Injection â†’ Use parameterized queries (pg-promise placeholders)"
                echo "  â€¢ XSS â†’ Sanitize user input, use DOMPurify for HTML"
                echo "  â€¢ Hardcoded Secrets â†’ Move to environment variables or Key Vault"
                echo "  â€¢ Insecure Randomness â†’ Use crypto.randomBytes() instead of Math.random()"
                echo "  â€¢ Command Injection â†’ Validate input, avoid shell execution"
                echo "  â€¢ Path Traversal â†’ Validate file paths, use path.resolve()"
                echo ""
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "ğŸ”§ False Positive?"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "If you believe this is a false positive:"
                echo "1. Document in .semgrep/ignore.yml with clear justification"
                echo "2. Get Security Team approval"
                echo "3. Include approval reference in commit message"
                echo ""
                echo "Example suppression:"
                echo "  rules:"
                echo "    - id: typescript.lang.security.audit.sql-injection"
                echo "      paths:"
                echo "        exclude:"
                echo "          - api/src/functions/YourFile.ts"
                echo "      note: \"False positive - uses pg-promise parameterized queries.\""
                echo "            \"Reviewed 2025-11-17 by Security Team.\""
                echo ""
                exit 1
              fi

              # Warn on WARNING severity
              if [ "$WARNING_COUNT" -gt 0 ]; then
                echo ""
                echo "âš ï¸ WARNING: $WARNING_COUNT potential security issues detected"
                echo ""
                echo "Findings (non-blocking):"
                echo ""
                jq -r '.results[] | select(.extra.severity == "WARNING") | "  ğŸŸ¡ \(.check_id)\n     File: \(.path):\(.start.line)\n     Message: \(.extra.message)\n"' semgrep-results.json | head -20
                echo ""
                echo "Review semgrep-results.json artifact for full details"
                echo ""
              fi

              echo ""
              echo "âœ… Semgrep SAST Check PASSED (no ERROR severity findings)"
              echo ""
            displayName: 'Validate Semgrep Results (BLOCKING on ERROR)'
            condition: succeededOrFailed()

          # Ensure Semgrep results file exists (create empty if not)
          - script: |
              if [ ! -f semgrep-results.json ]; then
                echo "âš ï¸ semgrep-results.json not found, creating empty results"
                echo '{"results":[],"errors":[],"paths":{"scanned":[]}}' > semgrep-results.json
              fi
            displayName: 'Ensure Semgrep results file exists'
            condition: always()

          # Publish Semgrep results as artifact (always, even on failure)
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Semgrep Report'
            condition: always()
            inputs:
              PathtoPublish: 'semgrep-results.json'
              ArtifactName: 'Semgrep-Results'
              publishLocation: 'Container'

          # ========================================
          # Gitleaks - Secret Scanning (Git History)
          # Scans entire git history for leaked secrets
          # ========================================
          - script: |
              echo "ğŸ” Installing Gitleaks..."
              wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
              tar -xzf gitleaks_8.18.0_linux_x64.tar.gz
              sudo mv gitleaks /usr/local/bin/
              gitleaks version
            displayName: 'Install Gitleaks'

          - script: |
              echo "ğŸ” Scanning for secrets in git history..."
              gitleaks detect \
                --source=. \
                --report-path=gitleaks-report.json \
                --exit-code=1 \
                --verbose
            displayName: 'Gitleaks: Secret scanning (git history)'
            continueOnError: true

          # Verify essential functions are compiled
          - script: |
              cd api
              if [ ! -f "dist/index.js" ]; then
                echo "âŒ ERROR: dist/index.js not found"
                exit 1
              fi
              if [ ! -d "dist/functions" ]; then
                echo "âŒ ERROR: dist/functions directory not found"
                exit 1
              fi
              echo "âœ… Build artifacts verified"
            displayName: 'Verify build artifacts'

          # Install Azure Functions Core Tools
          - script: |
              echo "ğŸ“¦ Installing Azure Functions Core Tools..."
              curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
              sudo mv microsoft.gpg /etc/apt/trusted.gpg.d/microsoft.gpg
              sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/microsoft-ubuntu-$(lsb_release -cs)-prod $(lsb_release -cs) main" > /etc/apt/sources.list.d/dotnetdev.list'
              sudo apt-get update
              sudo apt-get install azure-functions-core-tools-4 -y
              func --version
            displayName: 'Install Azure Functions Core Tools'

          # ========================================
          # Direct Production Deployment
          # NOTE: Staging slot deployment disabled (no slot configured)
          # TODO: Create staging slot for blue/green deployment
          # ========================================

          # Create deployment package
          - script: |
              cd api
              echo "ğŸ“¦ Creating deployment package..."

              # Create deployment directory with all required files
              mkdir -p .deploy
              cp -r dist .deploy/
              cp package.json .deploy/
              cp host.json .deploy/

              # Install production dependencies
              echo "ğŸ“¦ Installing production dependencies..."
              cd .deploy
              npm ci --production --silent

              # Create zip from deployment directory
              zip -r ../deploy.zip . -q
              cd ..

              # Clean up
              rm -rf .deploy

              echo "ğŸ“¦ Deployment package created: $(du -h deploy.zip | cut -f1)"
            displayName: 'Create deployment package'

          # Deploy using Azure CLI with zipDeploy
          - task: AzureCLI@2
            displayName: 'Deploy API to Production'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                cd api
                echo "ğŸš€ Deploying to $(functionAppName)..."

                # Deploy using webapp deployment (works with remote build disabled)
                az webapp deployment source config-zip \
                  --resource-group rg-ctn-demo-asr-dev \
                  --name $(functionAppName) \
                  --src deploy.zip \
                  --timeout 300

                echo "âœ… Deployment completed"

          # Configure CORS settings
          - task: AzureCLI@2
            displayName: 'Configure CORS settings'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "ğŸŒ Configuring CORS for Function App..."

                # Add all allowed origins
                az functionapp cors add \
                  --name $(functionAppName) \
                  --resource-group rg-ctn-demo-asr-dev \
                  --allowed-origins \
                    "http://localhost:3000" \
                    "http://localhost:3001" \
                    "https://calm-tree-03352ba03.1.azurestaticapps.net" \
                    "https://calm-pebble-043b2db03.1.azurestaticapps.net" \
                    "https://admin-ctn-dev-gma8fnethbetbjgj.z02.azurefd.net" \
                    "https://portal-ctn-dev-fdb5cpeagdendtck.z02.azurefd.net" \
                  2>&1 | grep -v "already exists" || true

                # Enable credentials support
                az functionapp cors credentials \
                  --name $(functionAppName) \
                  --resource-group rg-ctn-demo-asr-dev \
                  --enable

                echo "âœ… CORS configured with supportCredentials: true"

          # Health check on production (non-blocking, for informational purposes)
          - script: |
              echo "â³ Waiting 90 seconds for Azure Functions to initialize..."
              sleep 90

              echo "ğŸ” Running health check on PRODUCTION (NON-BLOCKING)..."
              PROD_URL="https://$(functionAppName).azurewebsites.net/api/health"
              MAX_RETRIES=3
              RETRY_DELAY=15

              # Retry health check up to 3 times
              for i in $(seq 1 $MAX_RETRIES); do
                echo "Health check attempt $i of $MAX_RETRIES..."
                HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$PROD_URL")

                if [ "$HEALTH_STATUS" = "200" ]; then
                  echo "âœ… Production health check passed (HTTP 200)"

                  # Get and display health details
                  curl -s "$PROD_URL" | jq '.'

                  # Extract commit hash
                  GIT_COMMIT=$(git rev-parse --short HEAD)
                  echo "ğŸ“¦ Production commit: $GIT_COMMIT"

                  exit 0
                fi

                echo "âš ï¸  Health check returned HTTP $HEALTH_STATUS, retrying in ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
              done

              echo "âš ï¸  Production health check did not pass after $MAX_RETRIES attempts"
              echo "   URL: $PROD_URL"
              echo "   Last status: $HEALTH_STATUS"
              echo "   NOTE: This is non-blocking. Manually verify deployment at:"
              echo "   https://func-ctn-demo-asr-dev.azurewebsites.net/api/health"
              exit 0
            displayName: 'Health Check - Production (NON-BLOCKING)'
            continueOnError: true

          # Deployment complete - display summary
          - script: |
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âœ… API DEPLOYMENT SUCCESSFUL"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "Production URL: https://$(functionAppName).azurewebsites.net"
              echo "API Version: 1.0.2"
              GIT_COMMIT=$(git rev-parse --short HEAD)
              echo "Git Commit: $GIT_COMMIT"
              echo ""
              echo "ğŸ“ Note: Direct production deployment (no staging slot)"
              echo "   To enable blue/green deployment, create staging slot in Azure"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""
            displayName: 'Deployment Summary'

          # List deployed functions
          - script: |
              echo "ğŸ“‹ Listing deployed functions..."
              az functionapp function list \
                --name $(functionAppName) \
                --resource-group rg-ctn-demo-asr-dev \
                --output table || echo "âš ï¸  Could not list functions (non-critical)"
            displayName: 'List deployed functions'
            continueOnError: true

  # Trigger downstream portal pipelines (Admin + Member only)
  - stage: TriggerPortals
    displayName: 'Trigger Portal Builds'
    dependsOn: BuildAndDeploy
    condition: succeeded()
    jobs:
      - job: TriggerAdminPortal
        displayName: 'Trigger Admin Portal Pipeline'
        steps:
          - task: AzureCLI@2
            displayName: 'Trigger Admin Portal build'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "ğŸš€ Triggering Admin Portal pipeline..."
                az pipelines run \
                  --org https://dev.azure.com/ctn-demo \
                  --project ASR \
                  --name "Association-Register-Admin" \
                  --branch main
                echo "âœ… Admin Portal pipeline triggered"

      - job: TriggerMemberPortal
        displayName: 'Trigger Member Portal Pipeline'
        steps:
          - task: AzureCLI@2
            displayName: 'Trigger Member Portal build'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "ğŸš€ Triggering Member Portal pipeline..."
                az pipelines run \
                  --org https://dev.azure.com/ctn-demo \
                  --project ASR \
                  --name "Association-Register-Member" \
                  --branch main
                echo "âœ… Member Portal pipeline triggered"
