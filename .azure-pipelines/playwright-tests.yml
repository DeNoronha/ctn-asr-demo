# Azure DevOps Pipeline for Playwright E2E Tests

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - admin-portal/e2e/**
      - member-portal/e2e/**
      - tests/*.setup.ts
      - playwright.config.ts

pr:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - admin-portal/e2e/**
      - member-portal/e2e/**
      - tests/*.setup.ts
      - playwright.config.ts

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: playwright-secrets  # Create this variable group in Azure DevOps
  - name: workingDirectory
    value: '.'
  - name: nodeVersion
    value: '20.x'

stages:
  - stage: Test
    displayName: 'E2E Testing'
    jobs:
      - job: PlaywrightTests
        displayName: 'Run Playwright Tests'
        timeoutInMinutes: 30

        steps:
          - task: NodeTool@0
            displayName: 'Setup Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          # ========================================
          # Cache: Root node_modules
          # Saves ~2-3 minutes on cache hit
          # ========================================
          - task: Cache@2
            displayName: 'Cache root node_modules'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: node_modules
              cacheHitVar: ROOT_NODE_MODULES_CACHE_RESTORED

          # ========================================
          # Cache: Playwright browsers
          # Saves ~1-2 minutes on cache hit
          # ========================================
          - task: Cache@2
            displayName: 'Cache Playwright browsers'
            inputs:
              key: 'playwright | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                playwright | "$(Agent.OS)"
              path: ~/.cache/ms-playwright
              cacheHitVar: PLAYWRIGHT_BROWSERS_CACHE_RESTORED

          - script: |
              npm ci --legacy-peer-deps
            displayName: 'Install dependencies'
            workingDirectory: $(workingDirectory)

          - script: |
              npx playwright install --with-deps chromium
            displayName: 'Install Playwright browsers'
            workingDirectory: $(workingDirectory)

          - script: |
              mkdir -p playwright/.auth
            displayName: 'Create auth directory'
            workingDirectory: $(workingDirectory)

          - task: DownloadSecureFile@1
            name: authState
            displayName: 'Download auth state'
            inputs:
              secureFile: 'playwright-auth.json'
            condition: succeededOrFailed()
            continueOnError: true

          - script: |
              if [ -f "$(authState.secureFilePath)" ]; then
                cp "$(authState.secureFilePath)" playwright/.auth/user.json
                echo "✅ Authentication state loaded"
              else
                echo "⚠️ No authentication state found - tests may fail"
              fi
            displayName: 'Setup auth state'
            workingDirectory: $(workingDirectory)

          - script: |
              npm run test:e2e
            displayName: 'Run Playwright tests'
            workingDirectory: $(workingDirectory)
            env:
              CI: true
              PLAYWRIGHT_BASE_URL: $(PlaywrightBaseURL)
              E2E_TEST_USER_EMAIL: $(E2ETestUserEmail)
              E2E_TEST_USER_PASSWORD: $(E2ETestUserPassword)
            continueOnError: false

          - task: PublishTestResults@2
            displayName: 'Publish test results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/playwright-report/results.xml'
              mergeTestResults: true
              failTaskOnFailedTests: true
            condition: succeededOrFailed()

          - task: PublishPipelineArtifact@1
            displayName: 'Publish HTML report'
            inputs:
              targetPath: '$(workingDirectory)/playwright-report'
              artifact: 'playwright-report'
              publishLocation: 'pipeline'
            condition: succeededOrFailed()

          - task: PublishPipelineArtifact@1
            displayName: 'Publish failure screenshots'
            inputs:
              targetPath: '$(workingDirectory)/test-results'
              artifact: 'playwright-screenshots'
              publishLocation: 'pipeline'
            condition: failed()

  - stage: Report
    displayName: 'Test Reporting'
    dependsOn: Test
    condition: always()
    jobs:
      - job: PublishResults
        displayName: 'Publish test summary'
        steps:
          - script: |
              echo "Playwright test execution completed"
              echo "View detailed report in pipeline artifacts"
            displayName: 'Summary'

# Setup Instructions:
#
# 1. Create Variable Group in Azure DevOps:
#    Library → Variable Groups → + Variable group
#    Name: playwright-secrets
#    Variables:
#      - PlaywrightBaseURL: https://calm-tree-03352ba03.1.azurestaticapps.net
#      - E2ETestUserEmail: test-e2@denoronha.consulting
#      - E2ETestUserPassword: [Link to Key Vault secret E2E-TEST-USER-PASSWORD]
#
# 2. Link Key Vault Secrets to Variable Group:
#    In variable group 'playwright-secrets':
#    - Add variable 'E2ETestUserPassword'
#    - Click "Link secrets from an Azure key vault as variables"
#    - Select Key Vault: kv-ctn-demo-asr-dev
#    - Add secret: E2E-TEST-USER-PASSWORD → E2ETestUserPassword
#
# 3. Upload Auth State as Secure File:
#    Pipelines → Library → Secure files → + Secure file
#    Upload: playwright/.auth/user.json (captured locally)
#    Name it: playwright-auth.json
#    Authorize for all pipelines
#
# 4. Grant Permissions:
#    Ensure service connection has access to variable group
#
# 5. Enable Pipeline:
#    Pipelines → New pipeline → Select this YAML file
