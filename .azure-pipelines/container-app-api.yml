# Container Apps API Pipeline
# Builds and deploys the API to Azure Container Apps

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - api/**
      - infrastructure/container-app.bicep
      - .azure-pipelines/container-app-api.yml

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: azureSubscription
    value: 'azure-ctn-demo'
  - name: containerRegistry
    value: 'crctnasrdev'
  - name: imageRepository
    value: 'ctn-asr-api'
  - name: dockerfilePath
    value: '$(Build.SourcesDirectory)/api/Dockerfile'
  - name: tag
    value: '$(Build.BuildId)'
  - name: resourceGroup
    value: 'rg-ctn-demo-asr-dev'

stages:
  - stage: Build
    displayName: 'Build and Push'
    jobs:
      - job: BuildAndPush
        displayName: 'Build and Push Docker Image'
        steps:
          - task: AzureCLI@2
            displayName: 'Build and Push Docker image'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Login to ACR
                az acr login --name $(containerRegistry)

                # Build the image
                docker build \
                  -t $(containerRegistry).azurecr.io/$(imageRepository):$(tag) \
                  -t $(containerRegistry).azurecr.io/$(imageRepository):latest \
                  -f $(dockerfilePath) \
                  $(Build.SourcesDirectory)/api

                # Push the images
                docker push $(containerRegistry).azurecr.io/$(imageRepository):$(tag)
                docker push $(containerRegistry).azurecr.io/$(imageRepository):latest

                echo "Image pushed: $(containerRegistry).azurecr.io/$(imageRepository):$(tag)"

  - stage: Deploy
    displayName: 'Deploy to Container Apps'
    dependsOn: Build
    jobs:
      - job: DeployContainerApp
        displayName: 'Deploy Container App'
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Deploy Container App'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Deploy Bicep template
                az deployment group create \
                  --resource-group $(resourceGroup) \
                  --template-file infrastructure/container-app.bicep \
                  --parameters \
                    environmentName=dev \
                    containerImage=$(containerRegistry).azurecr.io/$(imageRepository):$(tag)

                # Get the Container App URL
                CONTAINER_APP_URL=$(az containerapp show \
                  --name ca-ctn-asr-api-dev \
                  --resource-group $(resourceGroup) \
                  --query properties.configuration.ingress.fqdn \
                  --output tsv)

                echo "Container App deployed to: https://$CONTAINER_APP_URL"

          - task: AzureCLI@2
            displayName: 'Health Check'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Wait for deployment to stabilize
                sleep 30

                # Get Container App URL
                CONTAINER_APP_URL=$(az containerapp show \
                  --name ca-ctn-asr-api-dev \
                  --resource-group $(resourceGroup) \
                  --query properties.configuration.ingress.fqdn \
                  --output tsv)

                # Health check
                echo "Checking health at https://$CONTAINER_APP_URL/api/health"

                for i in 1 2 3 4 5; do
                  HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://$CONTAINER_APP_URL/api/health")
                  if [ "$HEALTH_STATUS" = "200" ]; then
                    echo "Health check passed!"
                    curl -s "https://$CONTAINER_APP_URL/api/health" | jq .
                    exit 0
                  fi
                  echo "Attempt $i: HTTP $HEALTH_STATUS - waiting..."
                  sleep 10
                done

                echo "Health check failed after 5 attempts"
                exit 1

  - stage: Test
    displayName: 'API Tests'
    dependsOn: Deploy
    jobs:
      - job: APITests
        displayName: 'Run API Tests'
        steps:
          - task: AzureCLI@2
            displayName: 'Run API Smoke Tests'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Get Container App URL
                CONTAINER_APP_URL=$(az containerapp show \
                  --name ca-ctn-asr-api-dev \
                  --resource-group $(resourceGroup) \
                  --query properties.configuration.ingress.fqdn \
                  --output tsv)

                API_BASE="https://$CONTAINER_APP_URL/api"

                echo "Testing API at $API_BASE"

                # Test health
                echo "Testing /health..."
                curl -s "$API_BASE/health" | jq .

                # Test version
                echo "Testing /v1/version..."
                curl -s "$API_BASE/v1/version" | jq .

                # Test public endpoint (register-member validation)
                echo "Testing /v1/register-member validation..."
                curl -s -X POST "$API_BASE/v1/register-member" -F "legalName=test" | jq .

                echo "API smoke tests completed!"
